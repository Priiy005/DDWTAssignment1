﻿@using WebMatrix.Data

@{
    ViewBag.Title = "Create";
    var db = Database.Open("BoardGame");
    var sql_families = $"select GF.FamilyCode, concat(GF.FamilyCode, ' - ', GF.Family) as FamilyName from GameFamily as GF";
    var fam_data = db.Query(sql_families, "");
    var sql_themes = "select ThemeID from Theme where ThemeName = @0";
    var sql_max_theme = "select ThemeID from Theme";
    var max_theme_id = db.Query(sql_max_theme);
    var max_id = 0;
    foreach(var row in max_theme_id)
    {
        if (max_id < Convert.ToInt32((row.ThemeID).Substring(1)))
        {
            max_id = Convert.ToInt32((row.ThemeID).Substring(1));
        }
    }

    if (IsPost)
    {
        var name = Request.Form["Name"];
        var family = Request.Form["familyID"];
        var year = Request.Form["year"];
        var description = Request.Form["description"];
        var image = Request.Form["imageurl"];
        var themeid = db.QueryValue(sql_themes, Request.Form["theme"]);
        var insert_gameinthemes = "insert into GameInThemes (BGGId, ThemeID) values (@0, @1)";
        var sql_insert = "Insert into Boardgame (BGGid, Name, Description, YearPublished, ImagePath, Family, GameWeight, MinPlayers, MaxPlayers, ComAgeRec, LanguageEase, BestPLayers, NumOwned, NumWant, NumWish, MfgPlayTime, ComMinPlaytime, ComMaxPlaytime, MfgAgeRec, NumAlternates, NumExpansions, NumImplementations, RankInboardgame, RankInstrategygames, RankInfamilygames, RankInthematic) values (@0, @1, @2, @3, @4, @5, @6, @7, @8, @9, @10, @11, @12, @13, @14, @15, @16, @17, @18, @19, @20, @21, @22, @23, @24, @25); select scope_identity()";
        var PK_query = "select TOP 1 * from Boardgame order by BGGid desc";
        var lastPK = db.QuerySingle(PK_query);


        if (themeid == null)
        {
            max_id += 1;
            themeid = 'T' + (max_id).ToString();
            var theme_insert = "insert into Theme (ThemeID, ThemeName) values (@0, @1)";
            db.Execute(theme_insert, themeid, Request.Form["theme"]);
        }

        var data = db.QueryValue(sql_insert, lastPK.BGGid + 1, name, description, year, image, family, Request.Form["weight"], Request.Form["minplay"], Request.Form["maxplay"], Request.Form["comagerec"], Request.Form["languageease"], Request.Form["bestplayers"], Request.Form["numowned"], Request.Form["numwant"], Request.Form["numwish"], Request.Form["MfgPlaytime"], Request.Form["comminplaytime"], Request.Form["commaxplaytime"], Request.Form["mfgagerec"], Request.Form["numalternates"], Request.Form["numexpansions"], Request.Form["numimplementations"], Request.Form["RankInboardgame"], Request.Form["rankinstrategy"], Request.Form["rankinfamily"], Request.Form["RankInthematic"]);
        db.Execute(insert_gameinthemes, (lastPK.BGGid + 1), themeid);
        Response.Redirect("/Home/Edit?id=" + (lastPK.BGGid + 1));

    }
}

<h2>Create</h2>

<form class="row" method="post" action="/Home/Create">
    <p>Item # [auto]</p>
    <div class="mb-2">
        <div>
            <p>Name</p>
            <input type="text" name="Name" placeholder="Boardgame Name" class="form-control" />
        </div>

        <p>Description</p>
        <textarea name="description" placeholder="description" class="form-control"></textarea>

        <p>Weight</p>
        <input type="number" name="weight" placeholder="Weight" class="form-control" />

        <p>MinPlayers</p>
        <input type="number" name="minplay" placeholder="Minimum players" class="form-control" />

        <p>MaxPlayers</p>
        <input type="number" name="maxplay" placeholder="Maximum players" class="form-control" />

        <p>Community Age Recommendation</p>
        <input type="number" name="comagerec" placeholder="Age Recommendation" class="form-control" />

        <p>LanguageEase</p>
        <input type="number" name="languageease" placeholder="Language Ease" class="form-control" />

        <p>BestPlayers</p>
        <input type="number" name="bestplayers" placeholder="BestPlayers" class="form-control" />

        <p>NumOwned</p>
        <input type="number" name="numowned" placeholder="Number Owned" class="form-control" />

        <p>NumWant</p>
        <input type="number" name="numwant" placeholder="Number Want" class="form-control" />

        <p>NumWish</p>
        <input type="number" name="numwish" placeholder="Number Wish" class="form-control" />

        <p>MfgPlaytime</p>
        <input type="number" name="MfgPlaytime" placeholder="Manufacturer Playtime" class="form-control" />

        <p>ComMinPlaytime</p>
        <input type="number" name="comminplaytime" placeholder="Community Minimum Playtime" class="form-control" />

        <p>ComMaxPlaytime</p>
        <input type="number" name="commaxplaytime" placeholder="Community Maximum Playtime" class="form-control" />

        <p>MfgAgeRec</p>
        <input type="number" name="mfgagerec" placeholder="Manufacturer Age Recommendation" class="form-control" />

        <p>NumAlternates</p>
        <input type="number" name="numalternates" placeholder="Number of alternates" class="form-control" />

        <p>NumExpansions</p>
        <input type="number" name="numexpansions" placeholder="Number of expansions" class="form-control" />

        <p>NumImplementations</p>
        <input type="number" name="numimplementations" placeholder="Number of implementations" class="form-control" />

        <p>RankInboardgame</p>
        <input type="number" name="RankInboardgame" placeholder="Rank In boardgame" class="form-control" />

        <p>RankInstrategygames</p>
        <input type="number" name="rankinstrategy" placeholder="Rank In strategy games" class="form-control" />

        <p>RankInfamilygames</p>
        <input type="number" name="rankinfamily" placeholder="Rank In family games" class="form-control" />

        <p>RankInthematic</p>
        <input type="number" name="RankInthematic" placeholder="Rank In thematic" class="form-control" />

        <div>
            <p>Category</p>
            <select name="familyID" class="dropdown">
                <option value="">Select Category</option>
                @foreach (var family in fam_data)
                {
                    <option value="@family.FamilyCode">@family.FamilyName</option>
                }
            </select>
        </div>

        <p>Theme</p>
        <input type="text" name="theme" placeholder="Game Theme" class="form-control" />

        <p>Year Published</p>
        <input type="date" name="year" placeholder="Date" class="form-control"/>

        <p>Image URL</p>
        <input name="imageurl" placeholder="imageurl" class="form-control" />

        <div class="justify-content-right">
            <button class="btn btn-primary">Save</button>
            <button class="btn btn-primary">Clear</button>
        </div>

    </div>
</form>